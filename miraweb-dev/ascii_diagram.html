<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIRA Conversation Flow - ASCII Style</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --secondary-light: #34d399;
            --accent: #8b5cf6;
            --accent-light: #a78bfa;
            --box-border: #d1d5db;
            --bg-light: #f9fafb;
            --text-dark: #1f2937;
            --text-medium: #4b5563;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body {
            font-family: 'Fira Code', 'Source Code Pro', monospace;
            line-height: 1.5;
            color: var(--text-dark);
            background-color: var(--bg-light);
            padding: 20px;
            overflow-x: auto;
        }
        
        h1 {
            text-align: center;
            margin: 20px 0 40px;
        }
        
        .diagram-container {
            white-space: pre;
            font-family: 'Fira Code', 'Source Code Pro', monospace;
            overflow-x: auto;
            padding: 20px;
            line-height: 1.2;
            background-color: white;
            box-shadow: var(--box-shadow);
            border-radius: 8px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .ascii-box {
            color: var(--primary);
            font-weight: bold;
        }
        
        .title-text {
            color: var(--text-dark);
            font-weight: bold;
        }
        
        .function-text {
            color: var(--secondary);
            font-style: italic;
        }
        
        .arrow-text {
            color: var(--accent);
            font-weight: bold;
        }
        
        .note-text {
            color: var(--text-medium);
            font-style: italic;
        }
        
        .process-text {
            color: var(--primary);
        }
        
        .highlight {
            color: var(--secondary);
            font-weight: bold;
        }
        
        /* Make the diagram visible on load */
        #flow-diagram {
            opacity: 1;
            transition: opacity 1s ease;
        }
        
        /* For printing */
        @media print {
            body {
                padding: 0;
                font-size: 9pt;
            }
            
            .diagram-container {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <h1>MIRA: She's not an idiot!</h1>
<pre id="flow-diagram">
┌─────────────────────────────────────────────────────────┐
│                <span class="title-text">USER INPUTS MESSAGE</span>                      │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│           <span class="function-text">conversation.add_message("user", message)</span>     │
│           <span class="note-text">(message added to conversation history)</span>       │
└───────────────────────────┬─────────────────────────────┘
                            │
          ┌─────────────────┴──────────────────┐
          │                                    │
          ▼                                    ▼
┌──────────────────────┐             ┌─────────────────────────┐
│  <span class="title-text">WORKFLOW DETECTION</span>  │             │  <span class="title-text">TOOL RELEVANCE ANALYSIS</span>│
│                     │             │                          │
│ <span class="function-text">workflow_manager.</span>    │             │ <span class="function-text">tool_relevance_engine.</span>  │ 
│ <span class="function-text">detect_workflow()</span>    │             │ <span class="function-text">manage_tool_relevance()</span>  │
└─────────┬────────────┘             └─────────────┬───────────┘
          │                                       │
          │ <span class="note-text">[If workflow detected]</span>                │ <span class="note-text">[If no active workflow]</span>
          │ <span class="note-text">Example: "calendar_booking"</span>           │
          │                                       │
          ▼                                       ▼
┌─────────────────────┐             ┌─────────────────────────┐
│ <span class="process-text">Store workflow ID &</span> │             │ <span class="process-text">Calculate relevance</span>     │
│ <span class="process-text">update working</span>      │             │ <span class="process-text">scores by comparing</span>     │
│ <span class="process-text">memory with hint</span>    │             │ <span class="process-text">message embedding</span>       │
└─────────┬───────────┘             │ <span class="process-text">to tool examples</span>        │
          │                         └─────────────┬───────────┘
          │                                       │
          │                                       ▼
          │                         ┌─────────────────────────┐
          │                         │ <span class="process-text">Enable relevant tools</span>   │
          │                         │ <span class="process-text">and disable tools</span>       │
          │                         │ <span class="process-text">no longer needed</span>        │
          │                         └─────────────┬───────────┘
          │                                       │
          └──────────────────┬────────────────────┘
                             │
                             ▼
┌───────────────────────────────────────────────────────────┐
│              <span class="title-text">PREPARE FOR LLM REQUEST</span>                      │
└───────────────────────────┬───────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
                ▼                       │
┌───────────────────────────┐           │
│     <span class="title-text">WORKING MEMORY</span>        │◄──────────┘
│       <span class="title-text">UPDATES</span>             │            
└───────────┬───────────────┘            
            │                
            │ 
            ▼
┌───────────────────────────────────────────────────────────┐
│                <span class="title-text">ACTIVE WORKFLOW EXAMPLE</span>                    │
│              <span class="note-text">(calendar_booking workflow)</span>                  │
└───────────┬───────────────────────────────────────────────┘
            │
            │
   ┌────────┴────────────────────────────────────┐
   │                                             │
   ▼                                             ▼
┌────────────────────────┐              ┌────────────────────────┐
│ <span class="title-text">WORKFLOW HEADER</span>        │              │ <span class="title-text">WORKFLOW STEPS</span>         │
│                        │              │                        │
│ • Workflow name        │              │ <span class="note-text">ONLY CURRENTLY</span>         │
│ • Description          │              │ <span class="note-text">AVAILABLE STEPS:</span>       │
│                        │              │                        │
│ <span class="note-text">Example:</span>               │              │ <span class="note-text">Example:</span>               │
│ <span class="highlight">"Calendar Booking</span>      │              │ <span class="highlight">1. Get event details</span>   │
│ <span class="highlight">workflow to schedule</span>   │              │    <span class="highlight">(ID: step1)</span>         │
│ <span class="highlight">appointments"</span>          │              │                        │
└────────────┬───────────┘              │    - Specific guidance │
             │                          │      for current step  │
             │                          │                        │
             │                          │    - Required inputs:  │
             │                          │      * Event title     │
             │                          │      * Date and time   │
             │                          │      * Duration        │
             │                          └────────────┬───────────┘
             │                                       │
             │                                       │
             ▼                                       ▼
┌────────────────────────┐              ┌────────────────────────┐
│ <span class="title-text">WORKFLOW CHECKLIST</span>     │              │ <span class="title-text">WORKFLOW DATA</span>          │
│                        │              │                        │
│ • Step 1: [<span class="highlight">🔄</span>] Get     │              │ Data collected so far: │
│   event details        │              │                        │
│   (ID: step1)          │              │ <span class="note-text">(Initially empty, gets</span> │
│                        │              │  <span class="note-text">updated as steps are</span>  │
│ • Step 2: [ ] Find     │              │  <span class="note-text">completed)</span>            │
│   available slots      │              │                        │
│   (ID: step2)          │              │ <span class="note-text">Example after step1:</span>   │
│                        │              │ • <span class="highlight">event_title: "Team</span>   │
│ • Step 3: [ ] Send     │              │   <span class="highlight">Meeting"</span>             │
│   invitations          │              │ • <span class="highlight">event_date: "2023-</span>   │
│   (ID: step3)          │              │   <span class="highlight">10-15T14:00:00"</span>      │
│                        │              │ • <span class="highlight">duration: 60</span>         │
└────────────┬───────────┘              └────────────┬───────────┘
             │                                       │
             │                                       │
             ▼                                       ▼
┌────────────────────────┐              ┌────────────────────────┐
│ <span class="title-text">WORKFLOW NAVIGATION</span>    │              │ <span class="title-text">TOOL ENABLEMENT</span>        │
│                        │              │                        │
│ Commands to navigate   │              │ Only enable tools      │
│ the workflow:          │              │ needed for current     │
│                        │              │ step:                  │
│ • <span class="function-text">&lt;workflow_complete_</span>  │              │                        │
│   <span class="function-text">step id="step1" /&gt;</span>   │              │ <span class="note-text">Example for step1:</span>     │
│                        │              │ • <span class="highlight">calendar_tool</span>        │
│ • <span class="function-text">&lt;workflow_skip_step</span>  │              │ • <span class="highlight">user_profile_tool</span>    │
│   <span class="function-text">id="step1" /&gt;</span>        │              │                        │
│                        │              │ <span class="note-text">(Other tools disabled)</span> │
│ • <span class="function-text">&lt;workflow_complete /&gt;</span>│              │                        │
│                        │              │                        │
└────────────┬───────────┘              └────────────┬───────────┘
             │                                       │
             └──────────────────┬────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────┐
│         <span class="function-text">working_memory.get_prompt_content()</span>               │
│         <span class="note-text">compiles all memory items into one string</span>         │
└───────────────────────────┬───────────────────────────────┘
                            │
                            │
┌───────────────────────────┴───────────────────────────────┐
│  <span class="title-text">PARALLEL MESSAGE PREPARATION</span>                             │
└─────────────────────────────────────────────────────────┐
                                                          │
┌───────────────────────────┐                             │
│<span class="process-text">Format message history</span>     │                             │
│<span class="function-text">conversation.get_formatted_</span>│                             │
│<span class="function-text">messages()</span>                 │                             │
└───────────┬───────────────┘                             │
            │                                             │
            │                                             │
            ▼                                             │
┌───────────────────────────┐                             │
│<span class="process-text">Get available tools</span>        │                             │
│<span class="function-text">tool_repo.get_all_tool_</span>    │                             │
│<span class="function-text">definitions()</span>              │                             │
│                           │                             │
│<span class="note-text">Example with workflow:</span>     │                             │
│• <span class="highlight">calendar_tool</span>            │                             │
│• <span class="highlight">user_profile_tool</span>        │                             │
└───────────┬───────────────┘                             │
            │                                             │
└───────────┼─────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────┐
│              <span class="title-text">FINAL LLM REQUEST ASSEMBLY</span>                 │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│ <span class="process-text">Assemble final LLM API request with:</span>                    │
│ <span class="process-text">1. Formatted message history</span>                            │
│ <span class="process-text">2. SYSTEM PROMPT = static system prompt +</span>               │
│ <span class="process-text">                   dynamic content from working memory</span>  │
│ <span class="process-text">3. Enabled tool definitions</span>                             │
│ <span class="process-text">4. API parameters (temp, max_tokens, etc.)</span>              │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│ <span class="function-text">Send API request to Claude API</span>                          │
│ <span class="function-text">llm_bridge.generate_response()</span>                          │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│ <span class="title-text">Process LLM Response</span>                                    │
└───────────────────────────┬─────────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              ▼                           ▼
┌───────────────────────┐     ┌───────────────────────┐
│<span class="process-text">Extract text content</span>   │     │<span class="process-text">Extract tool calls</span>     │
│<span class="process-text">from response</span>          │     │<span class="process-text">from response</span>          │
└─────────┬─────────────┘     └─────────┬─────────────┘
          │                             │
          ▼                             │
┌───────────────────────┐               │
│<span class="process-text">Parse tags from</span>        │               │
│<span class="process-text">response</span>               │               │
│<span class="note-text">(topic_changed, etc.)</span>  │               │
└─────────┬─────────────┘               │
          │                             │
          ▼                             │
┌───────────────────────┐               │
│<span class="process-text">Update topic_changed</span>   │               │
│<span class="process-text">flag in tool relevance</span> │               │
│<span class="process-text">engine for next round</span>  │◄──────────────┘
└─────────┬─────────────┘               │
          │                             ▼
          │               ┌───────────────────────────┐
          │               │ <span class="note-text">[If tool calls present]</span>   │
          │               │ <span class="process-text">Process each tool call</span>    │
          │               │ <span class="function-text">with tool_repo.invoke_tool</span>│
          │               └─────────┬─────────────────┘
          │                         │
          │                         ▼
          │               ┌───────────────────────────┐
          │               │<span class="process-text">Add tool results to</span>        │
          │               │<span class="process-text">conversation as user msg</span>   │
          │               │<span class="process-text">Continue API calls until</span>   │
          │               │<span class="process-text">no more tool calls</span>         │
          │               └─────────┬─────────────────┘
          │                         │
          └─────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ <span class="process-text">Check for workflow commands in response</span>                 │
│ <span class="function-text">workflow_manager.check_for_workflow_commands()</span>          │
└───────────────────────────┬─────────────────────────────┘
                            │
                            │
             ┌──────────────┴───────────────┐
             │                              │
             ▼                              ▼
┌───────────────────────────┐   ┌───────────────────────────┐
│ <span class="note-text">[If workflow command</span>      │   │ <span class="note-text">[If no workflow command]</span>  │
│  <span class="note-text">detected]</span>                │   │                           │
│                           │   │ <span class="process-text">Continue normal</span>           │
│ <span class="note-text">Example:</span>                  │   │ <span class="process-text">conversation flow</span>         │
│ <span class="function-text">&lt;workflow_complete_step</span>   │   │                           │
│  <span class="function-text">id="step1" /&gt;</span>            │   │                           │
└─────────┬─────────────────┘   └───────────────────────────┘
          │
          ▼
┌───────────────────────────┐
│ <span class="title-text">Update workflow state:</span>    │
│                           │
│ <span class="process-text">1. Mark step as completed</span> │
│ <span class="process-text">2. Store collected data</span>   │
│ <span class="process-text">3. Recalculate available</span>  │
│ <span class="process-text">   steps</span>                  │
│ <span class="process-text">4. Update tool access</span>     │
│                           │
│ <span class="note-text">Example after completing</span>  │
│ <span class="note-text">step1:</span>                    │
│ • <span class="highlight">step1 → completed</span>       │
│ • <span class="highlight">step2 → available</span>       │
│ • <span class="highlight">New tools enabled for</span>   │
│ <span class="highlight">  step2</span>                   │
└─────────┬─────────────────┘
          │
          ▼
┌───────────────────────────────────────────────┐
│ <span class="title-text">Update working memory with new workflow state</span> │
│                                               │
│ <span class="note-text">Example for step2:</span>                            │
│ • <span class="process-text">Remove step1 guidance</span>                       │
│ • <span class="process-text">Add step2 guidance</span>                          │
│ • <span class="process-text">Update checklist:</span>                           │
│   - <span class="highlight">Step 1: [✅] Get event details</span>            │
│   - <span class="highlight">Step 2: [🔄] Find available slots</span>         │
│ • <span class="process-text">Show collected data from step1</span>              │
└─────────┬─────────────────────────────────────┘
          │
          ▼
┌──────────────────────────────────────────────────────────┐
│ <span class="function-text">Add final response to conversation</span>                       │
│ <span class="function-text">conversation.add_message("assistant", assistant_response)</span>│
└───────────────────────────┬──────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│ <span class="title-text">Return response to user</span>                                 │
└─────────────────────────────────────────────────────────┘
</pre>
</body>
</html>